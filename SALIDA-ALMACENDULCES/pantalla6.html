<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen de salida - Dulces</title>
  <style>
    :root{
      --ticket-width-mm: 80;
      --ticket-margin-mm: 5;
    }
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(to right,#00416A,#E4E5E6);
      color: black;
      padding: 20px;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .contenedor{
      background: white;
      border-radius: 10px;
      padding: 16px 14px;
      max-width: 820px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header{text-align:center;margin-bottom:8px;}
    .logo{display:block;margin:0 auto 6px auto;width:220px;max-width:90%;image-rendering:-webkit-optimize-contrast;}
    .titulo{margin:2px 0 8px 0;color:#00416A;font-size:20px;font-weight:700;text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px 4px;text-align:center}
    th{background-color:#00416A;color:white}
    .firmas{display:flex;justify-content:space-around;margin-top:18px;gap:10px;flex-wrap:wrap}
    .firma-box{text-align:center}
    .firma-box img{width:180px;height:auto;border:1px solid #ccc}
    .btn-imprimir{
      display:block;margin:18px auto 0;
      padding:12px 20px;background-color:#0c6cbd;color:white;border:none;
      border-radius:6px;font-size:16px;cursor:pointer
    }
    .btn-imprimir:hover{background-color:#094a85}
    @media print {.btn-imprimir{display:none;}}
  </style>
</head>
<body>
  <div class="contenedor" id="resumenSalida">
    <div class="header">
      <img id="logoEmpresa" class="logo" src="logo_proveedora.webp" alt="Logo La Proveedora" crossOrigin="anonymous">
      <div class="titulo">Resumen de Salida - Almac√©n Dulces</div>
    </div>

    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Descripci√≥n</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <p>Firma entrega</p>
        <img id="firmaEntrega" alt="Firma entrega">
      </div>
      <div class="firma-box">
        <p>Firma recibe</p>
        <img id="firmaRecibe" alt="Firma recibe">
      </div>
    </div>
  </div>

  <button class="btn-imprimir" id="btnGuardarDescargar">Guardar y descargar PDF</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ================= CONFIGURACI√ìN =================
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

const BOT_ALIKA = "8241239653:AAH3-eS7XrRlO4G6LO5MydlYlOm2Um18SGE";
const CHAT_ALIKA = "6617988297";

    // üß† C√≥digos a ignorar
    const CODIGOS_IGNORADOS = ["060028","210004","210010","2382","250010","3062","3217","4451","7503033"];

    // ================= DATOS =================
    const folio   = localStorage.getItem('folio') || '';
    const fecha   = localStorage.getItem('fecha') || new Date().toLocaleString("es-MX");
    const entrega = localStorage.getItem('entrega') || '';
    const recibe  = localStorage.getItem('recibe') || '';
    const destino = localStorage.getItem('destino') || '';
    const productos = JSON.parse(localStorage.getItem('productosSeleccionados') || '[]');
    const firmaEntrega = localStorage.getItem('firmaEntrega') || '';
    const firmaRecibe  = localStorage.getItem('firmaRecibe')  || '';

    document.getElementById('folio').textContent = folio;
    document.getElementById('fecha').textContent = fecha;
    document.getElementById('entrega').textContent = entrega;
    document.getElementById('recibe').textContent = recibe;
    document.getElementById('destino').textContent = destino;
    document.getElementById('firmaEntrega').src = firmaEntrega;
    document.getElementById('firmaRecibe').src = firmaRecibe;

    const tabla = document.getElementById('tabla-productos');
    productos.forEach(p=>{
      const row=document.createElement('tr');
      row.innerHTML=`<td>${p.codigo||''}</td><td>${p.descripcion||''}</td><td>${p.cantidad||0}</td>`;
      tabla.appendChild(row);
    });

    // üö® Notificaci√≥n con el bot Star
    async function notificarStarDulce(salida){
      try{
        const token="8083018476:AAFXEdpxhVA6wjz2fQEOktxPFxq8zmc6X20";
        const chatId="6617988297";
        let msg=`üç¨ Nueva salida registrada en *Almac√©n Dulces*\n\nüìÑ Folio: ${salida.folio}\nüìÖ Fecha: ${salida.fecha}\nüë§ Entrega: ${salida.entrega}\nü§ù Recibe: ${salida.recibe}\nüìç Destino: ${salida.destino}\n\n`;
        if(Array.isArray(salida.productos)&&salida.productos.length>0){
          msg+=`üì¶ Productos:\n`;
          salida.productos.forEach(p=>{msg+=`‚Ä¢ ${p.cantidad} x ${p.descripcion}\n`;});
        }else msg+=`‚ö†Ô∏è No hay productos registrados.\n`;

        const frasesStar=[
          "üèπ‚ú® Star apunta siempre al orden, cada salida nos acerca a la victoria.",
          "üìö La disciplina es el arco que dispara el progreso. ‚Äì Star",
          "üèπ Cada registro es una flecha que fortalece al sistema. ‚Äì Star",
          "üìñ La bibliotecaria nunca olvida, cada salida queda guardada en la historia.",
          "üåü Sigue adelante, el orden es poder. ‚Äì Star",
          "üíª Cada l√≠nea de c√≥digo en PROVSOFT es un ladrillo en la fortaleza del futuro. ‚Äì Star",
          "üöÄ PROVSOFT crece con cada salida, y t√∫ creces con √©l. ‚Äì Star",
          "üî• No solo registramos productos, construimos legado con PROVSOFT. ‚Äì Star",
          "üè∞ PROVSOFT es la muralla, y cada registro la hace m√°s fuerte. ‚Äì Star"
        ];
        msg+=`\n\n${frasesStar[Math.floor(Math.random()*frasesStar.length)]}`;

        await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({chat_id:chatId,text:msg,parse_mode:"Markdown"})
        });
      }catch(e){console.warn("No se pudo notificar:",e);}
    }

// üßÆ Verificaci√≥n y actualizaci√≥n de inventario con historial y alertas
async function verificarInventarioYNotificar(productos){
  for(const art of productos){
    if(CODIGOS_IGNORADOS.includes(art.codigo)){
      console.log(`‚öôÔ∏è C√≥digo ${art.codigo} (${art.descripcion}) ignorado.`);
      continue;
    }

    try {
      const snap = await db.collection('seguimiento_inventario')
        .where('codigoBarra','==',art.codigo)
        .where('activo','==',true).get();

      if(!snap.empty){
        for(const docu of snap.docs){
          const data = docu.data();
          const ref = db.collection('seguimiento_inventario').doc(docu.id);

          const invActual = parseFloat(data.inventario_fijado || 0);
          const minimo = parseFloat(data.inventario_minimo || 0);
          const salida = parseFloat(art.cantidad || 0);
          const nuevo = Math.max(0, invActual - salida);

          console.log(`üç¨ ${art.codigo} ‚Üí Actual: ${invActual} | Salida: ${salida} | Nuevo: ${nuevo}`);

          // 1Ô∏è‚É£ Actualiza Firestore
          await ref.update({
            inventario_fijado: nuevo,
            ultima_salida: new Date().toISOString(),
            actualizadoEn: new Date().toISOString()
          });

          // 2Ô∏è‚É£ Registra en historial
          await ref.collection("historial").add({
            tipo: "salida",
            cantidad: salida,
            folio: folio || "SAL-DUL",
            fecha: new Date().toISOString(),
            usuario: entrega || "sistema",
            descripcion: "Salida autom√°tica registrada desde m√≥dulo Almac√©n Dulces"
          });

          // 3Ô∏è‚É£ Notifica a Telegram
          const esCritico = nuevo <= minimo;
          let msg = `üç¨ *Almac√©n Dulces ‚Äì Control de Stock*\n\n`;

          if(esCritico){
            msg += `üö® *ALERTA CR√çTICA DE INVENTARIO*\n`;
            msg += `üì¶ ${data.concepto || art.descripcion}\nüÜî C√≥digo: ${data.codigoBarra}\n`;
            msg += `üìâ Existencia actual: ${nuevo}\nüî¢ M√≠nimo definido: ${minimo}\n`;
            msg += `üè† Almac√©n: Dulces\nüìÖ ${new Date().toLocaleString("es-MX")}\n`;
            msg += `‚ö†Ô∏è *REPOSICI√ìN URGENTE NECESARIA* üö®`;
          } else {
            msg += `‚úÖ Inventario actualizado correctamente\n`;
            msg += `üì¶ ${data.concepto || art.descripcion}\nüÜî C√≥digo: ${data.codigoBarra}\n`;
            msg += `üì§ Salida reciente: ${salida}\nüìâ Existencia actual: ${nuevo}\n`;
            msg += `üî¢ M√≠nimo definido: ${minimo}\nüè† Almac√©n: Dulces\nüìÖ ${new Date().toLocaleString("es-MX")}`;
          }

          await fetch(`https://api.telegram.org/bot${BOT_ALIKA}/sendMessage`, {

            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              chat_id: CHAT_ALIKA,
              text: msg,
              parse_mode: "Markdown"
            })
          });

          console.log(`‚úÖ Inventario actualizado y notificado: ${art.codigo}`);
        }
      } else {
        console.log(`‚ÑπÔ∏è C√≥digo ${art.codigo} no encontrado en seguimiento_inventario`);
      }

    } catch (e) {
      console.error("‚ùå Error al actualizar inventario:", e);
    }
  }
}

    async function enviarAlertaInventario(item,nuevo,minimo){
      const esCritico=nuevo<=minimo;
      let msg=`üç¨ *Almac√©n Dulces ‚Äì Control de Stock*\n\n`;
      if(esCritico){
        msg+=`üö® *ALERTA CR√çTICA DE INVENTARIO*\nüì¶ ${item.concepto||item.descripcion}\nüÜî C√≥digo: ${item.codigoBarra}\nüìâ Existencia actual: ${nuevo}\nüî¢ M√≠nimo definido: ${minimo}\nüè† Almac√©n: Dulces\nüìÖ ${new Date().toLocaleString("es-MX")}\n‚ö†Ô∏è *REPOSICI√ìN URGENTE NECESARIA* üö®`;
      }else{
        msg+=`‚úÖ Inventario actualizado\nüì¶ ${item.concepto||item.descripcion}\nüÜî C√≥digo: ${item.codigoBarra}\nüìâ Actual: ${nuevo}\nüî¢ M√≠nimo: ${minimo}\nüè† Dulces\nüìÖ ${new Date().toLocaleString("es-MX")}`;
      }
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN_INV}/sendMessage`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({chat_id:CHAT_ID,text:msg,parse_mode:"Markdown"})
      });
    }

    // üîê Guardar en Firestore
    async function guardarSalida(){
      const data={folio,fecha,entrega,recibe,destino,productos,firmaEntrega,firmaRecibe,timestamp:firebase.firestore.FieldValue.serverTimestamp()};
      await db.collection("almacenes").doc("Almacen_Dulces").collection("salidas").add(data);
      const folioDoc=db.collection("consecutivos").doc("salidas_dulces");
      const snap=await folioDoc.get();
      if(snap.exists){await folioDoc.update({ultimo:(snap.data().ultimo||1)+1});}
      else{await folioDoc.set({ultimo:2});}
      await notificarStarDulce(data);
      await verificarInventarioYNotificar(productos);
    }

    // üßæ PDF
    function preload(imgEl){return new Promise(res=>{if(!imgEl)return res();if(imgEl.complete)return res();imgEl.onload=()=>res();imgEl.onerror=()=>res();});}
    async function descargarPDF(){
      const {jsPDF}=window.jspdf;
      const resumen=document.getElementById('resumenSalida');
      await Promise.all([preload(document.getElementById('logoEmpresa')),preload(document.getElementById('firmaEntrega')),preload(document.getElementById('firmaRecibe'))]);
      const canvas=await html2canvas(resumen,{scale:2,useCORS:true,backgroundColor:'#fff'});
      const imgData=canvas.toDataURL('image/png');
      const ticketWidthMM=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-width-mm'))||80;
      const marginMM=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-margin-mm'))||5;
      const usableWidthMM=ticketWidthMM-(marginMM*2);
      const pxPerMM=canvas.width/usableWidthMM;
      const heightMM=canvas.height/pxPerMM+(marginMM*2);
      const pdf=new jsPDF('p','mm',[ticketWidthMM,heightMM]);
      pdf.addImage(imgData,'PNG',marginMM,marginMM,usableWidthMM,canvas.height/pxPerMM);
      pdf.save(`Comprobante_${(folio||'SAL-DUL').replace(/\s+/g,'_')}.pdf`);
    }

    // üß© Flujo principal
    async function guardarYDescargar(){
      if(!productos||productos.length===0){alert("No hay productos.");return;}
      try{
        await guardarSalida();
        await descargarPDF();
        setTimeout(()=>{localStorage.clear();window.location.href="index.html";},2000);
      }catch(e){alert("Error: "+e.message);}
    }

    document.getElementById('btnGuardarDescargar').addEventListener('click',guardarYDescargar);
  </script>
</body>
</html>
