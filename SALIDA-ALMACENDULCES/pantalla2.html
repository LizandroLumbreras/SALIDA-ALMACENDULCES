<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar productos - Dulces</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      margin: 0;
      padding: 20px;
      color: white;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }
    .marca-agua {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.07;
      z-index: 0;
      max-width: 90%;
      pointer-events: none;
    }
    .contenedor {
      max-width: 700px;
      margin: auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      z-index: 1;
      position: relative;
    }
    h2 { text-align: center; margin-bottom: 20px; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; margin: 10px 0;
      border-radius: 6px; border: none; font-size: 16px;
    }
    .info-producto {
      background: white; color: black; padding: 15px;
      border-radius: 10px; margin-top: 10px; display: none;
    }
    .info-producto strong { display: block; margin-bottom: 5px; }
    button {
      background-color: #e60000; color: white; border: none;
      padding: 12px; width: 100%; border-radius: 6px; font-size: 16px;
      cursor: pointer; margin-top: 10px;
    }
    button:hover { background-color: #b00000; }
    .ayuda { font-size: 12px; opacity: .9; margin-top: -6px; }
    #buscador { font-size:16px; height:42px; }
#btnCamara { height:42px; }
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua">

  <div class="contenedor">
    <h2>Buscar producto</h2>
    <p class="ayuda">Escribe un <b>cÃ³digo</b> o el <b>inicio</b> del nombre (ej. "PALETA", "CHICLE").</p>

 <div style="display:flex; gap:8px; align-items:center;">
  <input
    type="text" id="buscador"
    placeholder="Buscar por cÃ³digo o nombre..."
    autofocus autocomplete="off" autocapitalize="off" spellcheck="false"
    style="flex:1;"
  />
  <button id="btnCamara" 
    style="padding:8px 12px;font-size:18px;border:none;border-radius:6px;background:#0c6cbd;color:white;cursor:pointer;flex-shrink:0;">
    ðŸ“·
  </button>
</div>

<div id="reader" 
     style="width:100%;max-width:260px;margin:8px auto;display:none;overflow:hidden;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);">
</div>
    <div class="info-producto" id="infoProducto">
      <strong id="descripcion"></strong>
      <div id="codigo"></div>
      <input type="number" id="cantidad" placeholder="Cantidad a retirar" step="0.001" min="0.001">
      <button id="btnAgregar">Agregar</button>
    </div>

    <button id="verCarritoBtn" onclick="irAlCarrito()" style="display:none;">Ver Carrito ðŸ›’</button>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Config bÃºsqueda (DULCES) =====
    const DEPTS_DULCES = ["DULCESIEPS", "CHICLEGRAVADO", "DULCESEXENTOS"];

    // ===== Estado =====
    let productoSeleccionado = null;

    // ===== Utils =====
    const pad13   = (s) => String(s).replace(/\s+/g,'').padStart(13,'0');
    const normCod = (s) => String(s).trim().replace(/[\s\r\n]+/g, '');
    const toUpper = (s) => String(s||'').toUpperCase();

    // âž• Variantes del cÃ³digo para cubrir EAN con/sin ceros a la izquierda
function variantesCodigo(raw){
  const limpio = String(raw).replace(/\s+/g,'');
  const pad13  = limpio.padStart(13,'0');
  const sin0   = limpio.replace(/^0+/, '');
  const set = new Set([limpio, pad13, sin0]);
  return Array.from(set).filter(Boolean);
}


    function esValido(d) {
      if (!d) return false;
      if (d.activo === false) return false;
      const dep = String(d.departamento || "").toUpperCase();
      return DEPTS_DULCES.includes(dep);
    }

    // ===== Render =====
    function mostrarProducto(p) {
      productoSeleccionado = p;
      document.getElementById('descripcion').textContent = p.concepto || 'Sin descripciÃ³n';
      document.getElementById('codigo').textContent = 'CÃ³digo: ' + (p.codigoBarra || p.id || '');
      document.getElementById('cantidad').value = '';
      document.getElementById('infoProducto').style.display = 'block';
      document.getElementById('cantidad').focus();
    }
    function ocultarProducto() {
      productoSeleccionado = null;
      document.getElementById('infoProducto').style.display = 'none';
    }
    function actualizarBotonCarrito() {
      const productos = JSON.parse(localStorage.getItem('productosSeleccionados') || '[]');
      document.getElementById('verCarritoBtn').style.display = productos.length > 0 ? 'block' : 'none';
    }

// ===== CONFIG ANTI-DUP =====
const SCAN_DEBOUNCE_MS = 800;
const TYPE_DEBOUNCE_MS = 300;

// â¬‡ï¸  MOVER buscador AFUERA del if para que sea visible en todo el archivo
const buscador = document.getElementById('buscador');

if (!window.__scannerHandlersBound) {
  window.__scannerHandlersBound = true;

  let lastScanCode = '';
  let lastScanAt = 0;
  let typingTimer = null;
  let processing = false;

  window.addEventListener('DOMContentLoaded', () => buscador && buscador.focus());

  // === ESCÃNER: Enter o Tab ===
  buscador.addEventListener('keydown', async (e) => {
    const isSubmitKey = (e.key === 'Enter' || e.key === 'Tab' || e.code === 'NumpadEnter');
    if (!isSubmitKey) return;
    if (e.repeat) return;
    e.preventDefault();
    e.stopPropagation();

    const raw = (buscador.value || '').replace(/[\r\n\t]+/g, '');
    const tCod = (raw.trim()).replace(/\s+/g, '');
    buscador.value = '';

    if (!tCod) return;

    const now = Date.now();
    if (tCod === lastScanCode && (now - lastScanAt) < SCAN_DEBOUNCE_MS) return;
    if (processing) return;

    lastScanCode = tCod;
    lastScanAt = now;
    processing = true;

try {
  if (/^\d+$/.test(tCod)) {
    // 1) Dulces por cÃ³digo
    let ok = await buscarPorCodigoDulces(tCod);
    // 2) Fallback equivalente por cÃ³digo
    if (!ok) ok = await buscarEquivalenteCodigo(tCod);
    // 3) Ãšltimo recurso: nombre en Dulces
    if (!ok) ok = await buscarPorNombreDulces(tCod);
    // 4) Ãšltimo-Ãºltimo: nombre equivalente
    if (!ok) await buscarEquivalenteNombre(tCod);
  } else {
    // texto: nombre
    let ok = await buscarPorNombreDulces(tCod);
    if (!ok) await buscarEquivalenteNombre(tCod);
  }
} catch (err) {
  console.error('[scanner handler]', err);
} finally {
  processing = false;
}
}); // ðŸ‘ˆ cierra el addEventListener('keydown', â€¦)

  // === TECLADO MANUAL: bÃºsqueda por nombre con debounce ===
  buscador.addEventListener('input', () => {
    if (typingTimer) clearTimeout(typingTimer);

    const val = (buscador.value || '').trim();
    if (val.length < 2) {
      if (typeof ocultarProducto === 'function') ocultarProducto();
      return;
    }
    if (/^\d{6,}$/.test(val)) return;

   typingTimer = setTimeout(async () => {
  try {
    let ok = await buscarPorNombreDulces(val);
    if (!ok) await buscarEquivalenteNombre(val);
  } catch (err) {
    console.error('[typing debounce]', err);
    ocultarProducto();
  }
}, TYPE_DEBOUNCE_MS);
   });
  buscador.addEventListener('change', () => {
    buscador.value = (buscador.value || '').replace(/[\r\n\t]+/g, '');
  });
}
    // ===== Helpers con filtros activo + departamento =====
    async function buscarPorCodigoDulces(code) {
  try {
    const variantes = variantesCodigo(code);

    // a) DocID exacto (probando variantes)
    for (const v of variantes) {
      const byId = await db.collection('productos').doc(v).get();
      if (byId.exists && esValido(byId.data())) {
        mostrarProducto({ id: byId.id, ...byId.data() });
        return true;
      }
    }

    // b) codigoBarra exacto (probando variantes)
    for (const v of variantes) {
      const q = await db.collection('productos')
        .where('activo','==', true)
        .where('departamento','in', DEPTS_DULCES)
        .where('codigoBarra','==', v)
        .limit(1).get();
      if (!q.empty) {
        const doc = q.docs[0];
        mostrarProducto({ id: doc.id, ...doc.data() });
        return true;
      }
    }

    // c) codigosEquivalentes (array-contains)
    for (const v of variantes) {
      const q = await db.collection('productos')
        .where('activo','==', true)
        .where('departamento','in', DEPTS_DULCES)
        .where('codigosEquivalentes','array-contains', v)
        .limit(1).get();
      if (!q.empty) {
        const doc = q.docs[0];
        mostrarProducto({ id: doc.id, ...doc.data() });
        return true;
      }
    }

    ocultarProducto();
    return false;
  } catch (e) {
    console.error('[ERROR buscarPorCodigoDulces]', e);
    ocultarProducto();
    return false;
  }
}
    async function buscarPorNombreDulces(texto) {
      try {
        const pref = toUpper(texto);
        const q2 = await db.collection('productos')
          .where('activo','==', true)
          .where('departamento','in', DEPTS_DULCES)
          .where('concepto','>=', pref)
          .where('concepto','<=', pref + '\uf8ff')
          .limit(20).get();

        if (!q2.empty) {
          const doc = q2.docs[0];
          mostrarProducto({ id: doc.id, ...doc.data() });
        } else {
          ocultarProducto();
        }
      } catch (e) {
        console.error('[ERROR buscarPorNombreDulces]', e);
        ocultarProducto();
      }
    }
// ðŸ” Fallback: catÃ¡logo equivalente (sin filtro de departamento)
async function buscarEquivalenteCodigo(code) {
  try {
    const variantes = variantesCodigo(code);

    // a) DocID
    for (const v of variantes) {
      const byId = await db.collection('productos').doc(v).get();
      if (byId.exists && byId.data()?.activo !== false) {
        mostrarProducto({ id: byId.id, ...byId.data() });
        return true;
      }
    }

    // b) codigoBarra
    for (const v of variantes) {
      const q = await db.collection('productos')
        .where('activo','==', true)
        .where('codigoBarra','==', v)
        .limit(1).get();
      if (!q.empty) {
        const doc = q.docs[0];
        mostrarProducto({ id: doc.id, ...doc.data() });
        return true;
      }
    }

    // c) codigosEquivalentes
    for (const v of variantes) {
      const q = await db.collection('productos')
        .where('activo','==', true)
        .where('codigosEquivalentes','array-contains', v)
        .limit(1).get();
      if (!q.empty) {
        const doc = q.docs[0];
        mostrarProducto({ id: doc.id, ...doc.data() });
        return true;
      }
    }

    ocultarProducto();
    return false;
  } catch (e) {
    console.error('[ERROR buscarEquivalenteCodigo]', e);
    ocultarProducto();
    return false;
  }
}

async function buscarEquivalenteNombre(texto) {
  try {
    const pref = toUpper(texto);
    const q = await db.collection('productos')
      .where('activo','==', true)
      .where('concepto','>=', pref)
      .where('concepto','<=', pref + '\uf8ff')
      .limit(20).get();

    if (!q.empty) {
      const doc = q.docs[0];
      mostrarProducto({ id: doc.id, ...doc.data() });
      return true;
    }
    ocultarProducto();
    return false;
  } catch (e) {
    console.error('[ERROR buscarEquivalenteNombre]', e);
    ocultarProducto();
    return false;
  }
}

    // ===== Agregar al carrito (Dulces) =====
    document.getElementById('btnAgregar').addEventListener('click', agregarProducto);
    function agregarProducto() {
      const cantidad = parseFloat(document.getElementById('cantidad').value);
      if (!cantidad || cantidad <= 0 || !productoSeleccionado) {
        alert('Verifica los datos');
        return;
      }
      const d = productoSeleccionado;
      const unidad = d.unidadMedidaSat || d.unidad || d.uMedida || 'N/D';

      const productos = JSON.parse(localStorage.getItem('productosSeleccionados') || '[]');
      productos.push({
        id: d.id,
        codigo: d.codigoBarra || d.id || '',
        descripcion: d.concepto || 'Sin descripciÃ³n',
        unidad: unidad,
        cantidad: cantidad
      });
      localStorage.setItem('productosSeleccionados', JSON.stringify(productos));

      ocultarProducto();
      document.getElementById('buscador').value = '';
      document.getElementById('cantidad').value = '';
      buscador.focus();
      actualizarBotonCarrito();
    }

    function irAlCarrito(){ window.location.href='pantalla3.html'; }
    window.irAlCarrito = irAlCarrito;

    // Init
    actualizarBotonCarrito();
  </script>
  <script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const btnCamara = document.getElementById('btnCamara');
  const lectorDiv = document.getElementById('reader');
  let html5Qr;

  async function iniciarCamara() {
    if (!html5Qr) html5Qr = new Html5Qrcode("reader");
    lectorDiv.style.display = 'block';
    btnCamara.disabled = true;

    const config = { fps: 10, qrbox: { width: 250, height: 120 } };

    try {
      await html5Qr.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          await html5Qr.stop();
          lectorDiv.style.display = 'none';
          btnCamara.disabled = false;
          buscador.value = decodedText.trim();
          buscador.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        },
        () => {}
      );
    } catch (err) {
      console.error("Error cÃ¡mara:", err);
      lectorDiv.style.display = 'none';
      btnCamara.disabled = false;
    }
  }

  btnCamara.addEventListener('click', iniciarCamara);
</script>
</body>
</html>
