<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar productos - Dulces</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      margin: 0;
      padding: 20px;
      color: white;
      min-height: 100vh;
    }
    .marca-agua {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      opacity: 0.07; z-index: 0; max-width: 90%; pointer-events: none;
    }
    .contenedor {
      max-width: 720px;
      margin: auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 22px;
      z-index: 1;
      position: relative;
    }
    h2 { text-align: center; margin-bottom: 16px; }
    .busqueda {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .busqueda input {
      flex: 1;
      padding: 14px 12px;
      border-radius: 8px;
      border: none;
      font-size: 18px;
      color: #222;
    }
    .busqueda button {
      background-color: #0c6cbd;
      border: none;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
    }
    .busqueda button:hover { background-color: #084d8a; }
    #camaraContainer {
      display: none;
      margin-top: 12px;
      text-align: center;
    }
    #reader {
      display: inline-block;
      width: 240px;
      height: 240px;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    .info-producto {
      background: white; color: black;
      padding: 15px; border-radius: 10px;
      margin-top: 10px; display: none;
    }
    .info-producto strong { display: block; margin-bottom: 5px; }
    button {
      background-color: #e60000; color: white;
      border: none; padding: 12px; width: 100%;
      border-radius: 6px; font-size: 16px;
      cursor: pointer; margin-top: 10px;
    }
    button:hover { background-color: #b00000; }
    .ayuda { font-size: 12px; opacity: .9; margin-top: -6px; }
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua">

  <div class="contenedor">
    <h2>Buscar producto</h2>
    <p class="ayuda">Escribe un <b>código</b> o el <b>inicio</b> del nombre (ej. "PALETA", "CHICLE").</p>

    <div class="busqueda">
      <input id="buscador" type="text"
        placeholder="Buscar por código o nombre..."
        autofocus autocomplete="off" autocapitalize="off" spellcheck="false">
      <button id="btnCamara">📷</button>
    </div>

    <div id="camaraContainer">
      <div id="reader"></div>
      <button id="btnCerrarCamara" style="background:#444;margin-top:8px;">Cerrar cámara</button>
    </div>

    <div class="info-producto" id="infoProducto">
      <strong id="descripcion"></strong>
      <div id="codigo"></div>
      <input type="number" id="cantidad" placeholder="Cantidad a retirar" step="0.001" min="0.001">
      <button id="btnAgregar">Agregar</button>
    </div>

    <button id="verCarritoBtn" onclick="irAlCarrito()" style="display:none;">Ver Carrito 🛒</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIGURACIÓN FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === CONFIG DEPARTAMENTOS ===
    const DEPTS_DULCES = ["DULCESIEPS", "CHICLEGRAVADO", "DULCESEXENTOS"];

    let productoSeleccionado = null;
    const buscador = document.getElementById('buscador');

    // === UTILIDADES ===
    const toUpper = s => String(s||'').toUpperCase();
    const variantesCodigo = raw => {
      const limpio = String(raw).trim().replace(/\s+/g,'');
      const pad13 = limpio.padStart(13,'0');
      const sin0 = limpio.replace(/^0+/,'');
      return Array.from(new Set([limpio,pad13,sin0])).filter(Boolean);
    };

    function esValido(d){
      if(!d) return false;
      if(d.activo===false) return false;
      const dep = String(d.departamento||"").toUpperCase();
      // ahora permite productos sin departamento o con nombre incompleto
      return !d.departamento || DEPTS_DULCES.includes(dep);
    }

    function mostrarProducto(p){
      productoSeleccionado=p;
      document.getElementById('descripcion').textContent=p.concepto||'Sin descripción';
      document.getElementById('codigo').textContent='Código: '+(p.codigoBarra||p.id||'');
      document.getElementById('cantidad').value='';
      document.getElementById('infoProducto').style.display='block';
      document.getElementById('cantidad').focus();
    }
    function ocultarProducto(){productoSeleccionado=null;document.getElementById('infoProducto').style.display='none';}
    function actualizarBotonCarrito(){
      const productos=JSON.parse(localStorage.getItem('productosSeleccionados')||'[]');
      document.getElementById('verCarritoBtn').style.display=productos.length>0?'block':'none';
    }

    async function buscarPorCodigoDulces(code){
      try{
        const variantes=variantesCodigo(code);
        // ID directo
        for(const v of variantes){
          const doc=await db.collection('productos').doc(v).get();
          if(doc.exists && esValido(doc.data())){mostrarProducto({id:doc.id,...doc.data()});return true;}
        }
        // código exacto
        for(const v of variantes){
          const q=await db.collection('productos')
            .where('activo','==',true)
            .where('codigoBarra','==',v)
            .limit(1).get();
          if(!q.empty){mostrarProducto({id:q.docs[0].id,...q.docs[0].data()});return true;}
        }
        // equivalentes
        for(const v of variantes){
          const q=await db.collection('productos')
            .where('activo','==',true)
            .where('codigosEquivalentes','array-contains',v)
            .limit(1).get();
          if(!q.empty){mostrarProducto({id:q.docs[0].id,...q.docs[0].data()});return true;}
        }
        ocultarProducto();
        return false;
      }catch(e){console.error('buscarPorCodigoDulces',e);ocultarProducto();return false;}
    }

    async function buscarPorNombreDulces(txt){
      const pref=toUpper(txt);
      const q=await db.collection('productos')
        .where('activo','==',true)
        .where('concepto','>=',pref)
        .where('concepto','<=',pref+'\uf8ff')
        .limit(20).get();
      if(!q.empty){mostrarProducto({id:q.docs[0].id,...q.docs[0].data()});return true;}
      ocultarProducto();return false;
    }

    document.getElementById('btnAgregar').addEventListener('click',()=>{
      const c=parseFloat(document.getElementById('cantidad').value);
      if(!c||c<=0||!productoSeleccionado){alert('Verifica los datos');return;}
      const d=productoSeleccionado;
      const unidad=d.unidadMedidaSat||d.unidad||d.uMedida||'N/D';
      const productos=JSON.parse(localStorage.getItem('productosSeleccionados')||'[]');
      productos.push({id:d.id,codigo:d.codigoBarra||d.id,descripcion:d.concepto||'',unidad:unidad,cantidad:c});
      localStorage.setItem('productosSeleccionados',JSON.stringify(productos));
      ocultarProducto();buscador.value='';buscador.focus();actualizarBotonCarrito();beep();
    });
    function irAlCarrito(){window.location.href='pantalla3.html';}

    actualizarBotonCarrito();

    // === CÁMARA ===
    const btnCamara=document.getElementById('btnCamara');
    const camaraContainer=document.getElementById('camaraContainer');
    const btnCerrarCamara=document.getElementById('btnCerrarCamara');
    let html5QrCode=null;

    function beep(){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const osc=ctx.createOscillator();
        const gain=ctx.createGain();
        osc.connect(gain);gain.connect(ctx.destination);
        osc.type="square";osc.frequency.value=880;
        gain.gain.setValueAtTime(0.12,ctx.currentTime);
        osc.start();osc.stop(ctx.currentTime+0.15);
      }catch(e){}
    }

    btnCamara.addEventListener('click',()=>{camaraContainer.style.display==='block'?cerrarCamara():abrirCamara();});
    async function abrirCamara(){
      camaraContainer.style.display='block';
      html5QrCode=new Html5Qrcode("reader");
      const devices=await Html5Qrcode.getCameras();
      if(devices.length){
        await html5QrCode.start(
          devices[0].id,{fps:10,qrbox:{width:200,height:200}},
          code=>{
            beep();
            buscador.value=code;
            buscarPorCodigoDulces(code);
            html5QrCode.pause();
            setTimeout(()=>html5QrCode.resume(),1200);
          });
      }else alert('No se detectó cámara');
    }
    async function cerrarCamara(){
      camaraContainer.style.display='none';
      if(html5QrCode){await html5QrCode.stop();html5QrCode.clear();}
    }
    btnCerrarCamara.addEventListener('click',cerrarCamara);
  </script>
</body>
</html>
