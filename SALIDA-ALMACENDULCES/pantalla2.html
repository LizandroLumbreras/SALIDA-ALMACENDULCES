<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar productos - Dulces</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right,#00416A,#E4E5E6);
      margin:0; padding:20px; color:white; min-height:100vh;
    }
    .marca-agua {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      opacity:0.07; z-index:0; max-width:90%; pointer-events:none;
    }
    .contenedor {
      max-width:700px; margin:auto; background:rgba(255,255,255,0.1);
      border-radius:10px; padding:20px; z-index:1; position:relative;
    }
    h2{text-align:center;margin-bottom:20px}
    .busqueda{display:flex; gap:8px; align-items:center;}
    .busqueda input{
      flex:1; padding:10px; border-radius:6px; border:none;
      font-size:16px;
    }
    .busqueda button{
      background:#0c6cbd; border:none; color:#fff;
      padding:10px 14px; border-radius:6px; cursor:pointer;
      font-size:18px;
    }
    .busqueda button:hover{background:#084d8a}
    #camaraContainer{display:none; margin-top:15px;}
    #reader{width:100%; border-radius:8px; overflow:hidden;}
    .info-producto{
      background:#fff; color:#000; padding:15px;
      border-radius:10px; margin-top:10px; display:none;
    }
    button#btnAgregar, #verCarritoBtn{
      background:#e60000; color:white; border:none;
      padding:12px; width:100%; border-radius:6px;
      font-size:16px; cursor:pointer; margin-top:10px;
    }
    button#btnAgregar:hover, #verCarritoBtn:hover{background:#b00000}
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua">
  <div class="contenedor">
    <h2>Buscar producto</h2>
    <p>Escribe o escanea el código del producto.</p>

    <div class="busqueda">
      <input id="buscador" type="text" placeholder="Buscar por código o nombre..." autocomplete="off" autofocus>
      <button id="btnCamara">📷</button>
    </div>

    <div id="camaraContainer">
      <div id="reader"></div>
      <button id="btnCerrarCamara" style="margin-top:8px;background:#444;">Cerrar cámara</button>
    </div>

    <div class="info-producto" id="infoProducto">
      <strong id="descripcion"></strong>
      <div id="codigo"></div>
      <input type="number" id="cantidad" placeholder="Cantidad" step="0.001" min="0.001">
      <button id="btnAgregar">Agregar</button>
    </div>

    <button id="verCarritoBtn" onclick="irAlCarrito()" style="display:none;">Ver Carrito 🛒</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // === Firebase ===
    const firebaseConfig={
      apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain:"inventariopv-643f1.firebaseapp.com",
      projectId:"inventariopv-643f1",
      storageBucket:"inventariopv-643f1.appspot.com",
      messagingSenderId:"96242533231",
      appId:"1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const DEPTS_DULCES=["DULCESIEPS","CHICLEGRAVADO","DULCESEXENTOS"];
    let productoSeleccionado=null;
    const buscador=document.getElementById('buscador');
    const camaraDiv=document.getElementById('camaraContainer');
    const readerDiv=document.getElementById('reader');
    const btnCamara=document.getElementById('btnCamara');
    const btnCerrar=document.getElementById('btnCerrarCamara');
    let html5QrCode=null;

    // === sonido beep ===
    function beep(){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const osc=ctx.createOscillator();
        const gain=ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type="square"; osc.frequency.value=880;
        gain.gain.setValueAtTime(0.1,ctx.currentTime);
        osc.start();
        osc.stop(ctx.currentTime+0.15);
      }catch(e){console.warn("No beep",e);}
    }

    const toUpper=s=>String(s||'').toUpperCase();
    function esValido(d){return d && d.activo!==false && DEPTS_DULCES.includes(String(d.departamento||'').toUpperCase());}
    function mostrarProducto(p){
      productoSeleccionado=p;
      document.getElementById('descripcion').textContent=p.concepto||'Sin descripción';
      document.getElementById('codigo').textContent='Código: '+(p.codigoBarra||p.id||'');
      document.getElementById('infoProducto').style.display='block';
      document.getElementById('cantidad').focus();
    }
    function ocultarProducto(){productoSeleccionado=null;document.getElementById('infoProducto').style.display='none';}

    async function buscarPorCodigo(code){
      try{
        const variantes=[code,code.padStart(13,'0'),code.replace(/^0+/,'')];
        for(const v of variantes){
          const doc=await db.collection('productos').doc(v).get();
          if(doc.exists && esValido(doc.data())){mostrarProducto({id:doc.id,...doc.data()});return;}
        }
        for(const v of variantes){
          const q=await db.collection('productos')
            .where('activo','==',true)
            .where('departamento','in',DEPTS_DULCES)
            .where('codigoBarra','==',v).limit(1).get();
          if(!q.empty){mostrarProducto({id:q.docs[0].id,...q.docs[0].data()});return;}
        }
        ocultarProducto();
      }catch(e){console.error(e);ocultarProducto();}
    }

    buscador.addEventListener('keydown',e=>{
      if(e.key==='Enter'){buscarPorCodigo(buscador.value.trim());}
    });

    // === Botón cámara ===
    btnCamara.addEventListener('click',()=>{
      if(camaraDiv.style.display==='block'){cerrarCamara();return;}
      abrirCamara();
    });

    async function abrirCamara(){
      camaraDiv.style.display='block';
      html5QrCode=new Html5Qrcode("reader");
      const devices=await Html5Qrcode.getCameras();
      if(devices.length){
        await html5QrCode.start(
          devices[0].id,
          {fps:10,qrbox:{width:250,height:250}},
          code=>{
            beep(); // sonido al detectar
            buscarPorCodigo(code);
            html5QrCode.pause();
            setTimeout(()=>html5QrCode.resume(),1500);
          }
        );
      }else alert('No se detectó cámara');
    }

    async function cerrarCamara(){
      camaraDiv.style.display='none';
      if(html5QrCode){await html5QrCode.stop();html5QrCode.clear();}
    }
    btnCerrar.addEventListener('click',cerrarCamara);

    // === Agregar al carrito ===
    document.getElementById('btnAgregar').addEventListener('click',()=>{
      const c=parseFloat(document.getElementById('cantidad').value);
      if(!c||!productoSeleccionado){alert('Verifica los datos');return;}
      const d=productoSeleccionado;
      const lista=JSON.parse(localStorage.getItem('productosSeleccionados')||'[]');
      lista.push({id:d.id,codigo:d.codigoBarra||d.id,descripcion:d.concepto||'',cantidad:c});
      localStorage.setItem('productosSeleccionados',JSON.stringify(lista));
      ocultarProducto();buscador.value='';buscador.focus();
      document.getElementById('verCarritoBtn').style.display='block';
    });
    function irAlCarrito(){window.location.href='pantalla3.html';}
  </script>
</body>
</html>
