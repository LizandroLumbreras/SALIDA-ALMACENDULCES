<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen de salida - Dulces</title>
  <style>
    body{font-family:Arial,sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);color:black;padding:20px;box-sizing:border-box;min-height:100vh}
    .contenedor{background:white;border-radius:10px;padding:20px;max-width:800px;margin:auto;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    h2{text-align:center;color:#00416A}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background-color:#00416A;color:white}
    .firmas{display:flex;justify-content:space-around;margin-top:30px;flex-wrap:wrap}
    .firma-box{text-align:center}
    .firma-box img{width:200px;height:auto;border:1px solid #ccc}
    .btn-imprimir{display:block;margin:30px auto 0;padding:12px 20px;background-color:#d32f2f;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    .btn-imprimir:hover{background-color:#b71c1c}
  </style>
</head>
<body>
  <div class="contenedor">
    <h2>Resumen de Salida - Dulces</h2>
    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Unidad</th>
        </tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <p>Firma entrega</p>
        <img id="firmaEntrega" alt="Firma entrega">
      </div>
      <div class="firma-box">
        <p>Firma recibe</p>
        <img id="firmaRecibe" alt="Firma recibe">
      </div>
    </div>

    <button class="btn-imprimir" onclick="guardarEImprimir()">Imprimir y guardar salida</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Datos desde localStorage
    const folio   = localStorage.getItem('folio') || '';
    const fecha   = localStorage.getItem('fecha') || new Date().toLocaleString("es-MX");
    const entrega = localStorage.getItem('entrega') || '';
    const recibe  = localStorage.getItem('recibe') || '';
    const destino = localStorage.getItem('destino') || '';
    const productos = JSON.parse(localStorage.getItem('productosSeleccionados') || '[]');
    const firmaEntrega = localStorage.getItem('firmaEntrega') || '';
    const firmaRecibe  = localStorage.getItem('firmaRecibe')  || '';

    // Pintar encabezado y firmas
    document.getElementById('folio').textContent = folio;
    document.getElementById('fecha').textContent = fecha;
    document.getElementById('entrega').textContent = entrega;
    document.getElementById('recibe').textContent = recibe;
    document.getElementById('destino').textContent = destino;
    document.getElementById('firmaEntrega').src = firmaEntrega;
    document.getElementById('firmaRecibe').src = firmaRecibe;

    // Tabla de productos
    const tabla = document.getElementById('tabla-productos');
    productos.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.codigo || ''}</td>
        <td>${p.descripcion || ''}</td>
        <td>${p.cantidad || 0}</td>
        <td>${p.unidad || 'N/D'}</td>
      `;
      tabla.appendChild(row);
    });

    // Guardar en Firestore y luego imprimir
    async function guardarEImprimir() {
    if (!productos || productos.length === 0) {
      alert("No hay productos en el resumen.");
      return;
    }

    const data = {
      folio, fecha, entrega, recibe, destino, productos, firmaEntrega, firmaRecibe,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      // 1) Guardar salida
      await db.collection("almacenes")
        .doc("Almacen_Dulces")
        .collection("salidas")
        .add(data);

      // 2) Avanzar consecutivo
      const folioDoc = db.collection("consecutivos").doc("salidas_dulces");
      const snap = await folioDoc.get();
      if (snap.exists) {
        await folioDoc.update({ ultimo: (snap.data().ultimo || 1) + 1 });
      } else {
        await folioDoc.set({ ultimo: 2 });
      }

      // 3) Preparar redirección al cerrar el diálogo de impresión
      const irAlInicio = () => {
        // Limpieza opcional del flujo anterior
        localStorage.removeItem("productosSeleccionados");
        localStorage.removeItem("firmaEntrega");
        localStorage.removeItem("firmaRecibe");
        localStorage.removeItem("entrega");
        localStorage.removeItem("recibe");
        localStorage.removeItem("destino");
        // Nota: el index vuelve a escribir "folio" y "fecha"
        window.location.href = "index.html";
      };

      // Redirige al terminar de imprimir (mejor soporte cross-browser)
      if ("onafterprint" in window) {
        window.onafterprint = irAlInicio;
      }
      // Fallback por si el navegador no dispara onafterprint
      setTimeout(irAlInicio, 60000); // 60s de seguridad

      // 4) Imprimir
      window.print();

    } catch (e) {
      alert("Error al guardar: " + e.message);
    }
  }

  // Exponer función al botón
  window.guardarEImprimir = guardarEImprimir;
  </script>
</body>
</html>
