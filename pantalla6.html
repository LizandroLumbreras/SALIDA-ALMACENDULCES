<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen de salida - Dulces</title>
  <style>
    :root{
      --ticket-width-mm: 80;   /* ancho papel térmico */
      --ticket-margin-mm: 5;   /* márgenes del PDF */
    }

    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(to right,#00416A,#E4E5E6);
      color: black;
      padding: 20px;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .contenedor{
      background: white;
      border-radius: 10px;
      padding: 16px 14px;
      max-width: 820px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* ====== ENCABEZADO CON LOGO ====== */
    .header{
      text-align: center;
      margin-bottom: 8px;
    }
    .logo{
      display:block;
      margin: 0 auto 6px auto;
      width: 220px;            /* tamaño en pantalla */
      max-width: 90%;
      image-rendering: -webkit-optimize-contrast;
      filter: grayscale(0);    /* pon 100% si tu térmica imprime mejor en B/N */
    }
    .titulo{
      margin: 2px 0 8px 0;
      color: #00416A;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
    }

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px 4px;text-align:center}
    th{background-color:#00416A;color:white}

    .firmas{
      display:flex;
      justify-content:space-around;
      margin-top:18px;
      gap: 10px;
      flex-wrap:wrap
    }
    .firma-box{text-align:center}
    .firma-box img{width:180px;height:auto;border:1px solid #ccc}

    .btn-imprimir{
      display:block;margin:18px auto 0;
      padding:12px 20px;background-color:#d32f2f;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer
    }
    .btn-imprimir:hover{background-color:#b71c1c}

    /* ====== IMPRESIÓN EN TÉRMICA ====== */
    @media print {
      body{
        background:#fff !important;
        padding:0;
      }
      .contenedor{
        box-shadow:none;
        border-radius:0;
        padding: 8px 6px;
        width: calc(var(--ticket-width-mm) * 1mm);
        margin: 0 auto;
      }
      .logo{ width: 60mm; max-width: 100%; }   /* adapta al ancho del ticket */
      .titulo{ font-size: 16px; }
      table, th, td{ font-size: 12px; }
      .firma-box img{ width: 50mm; }
      .btn-imprimir{ display:none; }
    }
  </style>
</head>
<body>
  <!-- IMPORTANTE: id para capturar el PDF -->
  <div class="contenedor" id="resumenSalida">
    <div class="header">
      <!-- Cambia la ruta si tu archivo se llama distinto -->
      <img id="logoEmpresa" class="logo" src="logo_proveedora.png" alt="Logo La Proveedora" crossOrigin="anonymous">
      <div class="titulo">Resumen de Salida - Dulces</div>
    </div>

    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Descripción</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <p>Firma entrega</p>
        <img id="firmaEntrega" alt="Firma entrega">
      </div>
      <div class="firma-box">
        <p>Firma recibe</p>
        <img id="firmaRecibe" alt="Firma recibe">
      </div>
    </div>
  </div>

  <button class="btn-imprimir" id="btnGuardarImprimir">Imprimir y guardar salida</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Librerías para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Datos desde localStorage
    const folio   = localStorage.getItem('folio') || '';
    const fecha   = localStorage.getItem('fecha') || new Date().toLocaleString("es-MX");
    const entrega = localStorage.getItem('entrega') || '';
    const recibe  = localStorage.getItem('recibe') || '';
    const destino = localStorage.getItem('destino') || '';
    const productos = JSON.parse(localStorage.getItem('productosSeleccionados') || '[]');
    const firmaEntrega = localStorage.getItem('firmaEntrega') || '';
    const firmaRecibe  = localStorage.getItem('firmaRecibe')  || '';

    // Pintar encabezado y firmas
    document.getElementById('folio').textContent = folio;
    document.getElementById('fecha').textContent = fecha;
    document.getElementById('entrega').textContent = entrega;
    document.getElementById('recibe').textContent = recibe;
    document.getElementById('destino').textContent = destino;
    document.getElementById('firmaEntrega').src = firmaEntrega;
    document.getElementById('firmaRecibe').src = firmaRecibe;

    // Tabla de productos
    const tabla = document.getElementById('tabla-productos');
    productos.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.codigo || ''}</td>
        <td>${p.descripcion || ''}</td>
        <td>${p.cantidad || 0}</td>
      `;
      tabla.appendChild(row);
    });

    // Limpieza y regreso al inicio
    const irAlInicio = () => {
      localStorage.removeItem("productosSeleccionados");
      localStorage.removeItem("firmaEntrega");
      localStorage.removeItem("firmaRecibe");
      localStorage.removeItem("entrega");
      localStorage.removeItem("recibe");
      localStorage.removeItem("destino");
      window.location.href = "index.html";
    };

    // Guarda en Firestore
    async function guardarSalida() {
      const data = {
        folio, fecha, entrega, recibe, destino, productos, firmaEntrega, firmaRecibe,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection("almacenes")
        .doc("Almacen_Dulces")
        .collection("salidas")
        .add(data);

      const folioDoc = db.collection("consecutivos").doc("salidas_dulces");
      const snap = await folioDoc.get();
      if (snap.exists) {
        await folioDoc.update({ ultimo: (snap.data().ultimo || 1) + 1 });
      } else {
        await folioDoc.set({ ultimo: 2 });
      }
    }

    // Preload imágenes para html2canvas (logo y firmas)
    function preload(imgEl){
      return new Promise(res=>{
        if(!imgEl) return res();
        if (imgEl.complete) return res();
        imgEl.onload = ()=>res();
        imgEl.onerror = ()=>res();
      });
    }

    // Genera y descarga PDF en tamaño térmico (80mm)
    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const resumen = document.getElementById('resumenSalida');

      await Promise.all([
        preload(document.getElementById('logoEmpresa')),
        preload(document.getElementById('firmaEntrega')),
        preload(document.getElementById('firmaRecibe')),
      ]);

      const canvas = await html2canvas(resumen, {
        scale: 2, useCORS: true, backgroundColor: '#ffffff'
      });
      const imgData = canvas.toDataURL('image/png');

      // Configuración de ticket 80mm
      const ticketWidthMM = parseFloat(getComputedStyle(document.documentElement)
        .getPropertyValue('--ticket-width-mm')) || 80;
      const marginMM = parseFloat(getComputedStyle(document.documentElement)
        .getPropertyValue('--ticket-margin-mm')) || 5;

      // Relación px -> mm según el ancho deseado
      // Queremos que el contenido ocupe (ticketWidthMM - 2*marginMM)
      const imgPxWidth = canvas.width;
      const imgPxHeight = canvas.height;

      const usableWidthMM = ticketWidthMM - (marginMM * 2);
      const pxPerMM = imgPxWidth / usableWidthMM;
      const heightMM = imgPxHeight / pxPerMM + (marginMM * 2);

      // Crear PDF con tamaño personalizado [ancho, alto] en mm
      const pdf = new jsPDF('p', 'mm', [ticketWidthMM, heightMM]);
      const x = marginMM;
      const y = marginMM;
      const w = usableWidthMM;
      const h = imgPxHeight / pxPerMM;

      pdf.addImage(imgData, 'PNG', x, y, w, h);
      const nombre = `Comprobante_${(folio || 'SALDUL').replace(/\s+/g,'_')}.pdf`;
      pdf.save(nombre);
    }

    async function guardarEImprimir() {
      if (!productos || productos.length === 0) {
        alert("No hay productos en el resumen.");
        return;
      }

      try {
        await guardarSalida();          // Guardar en Firestore
        await descargarPDF();           // Descargar comprobante
        if ("onafterprint" in window) {
          window.onafterprint = irAlInicio;
        }
        setTimeout(irAlInicio, 60000);  // Fallback 60s
        window.print();                 // Imprimir (usa @media print)
      } catch (e) {
        alert("Error: " + e.message);
      }
    }

    document.getElementById('btnGuardarImprimir').addEventListener('click', guardarEImprimir);
  </script>
</body>
</html>
