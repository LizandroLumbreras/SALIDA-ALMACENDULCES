<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumen Final ‚Äì Almac√©n L√≠quidos</title>
  <style>
    :root{
      --ticket-width-mm: 80;   /* ancho papel t√©rmico */
      --ticket-margin-mm: 5;   /* m√°rgenes del PDF */
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      margin: 0;
      padding: 20px;
      color: #111;
    }
    .contenedor {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      color: #00416A;
    }
    .info p {
      margin: 6px 0;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #00416A;
      color: white;
    }
    .firmas {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .firma-box {
      text-align: center;
      margin: 10px;
    }
    .firma-box img {
      border: 1px solid #ccc;
      width: 200px;
      height: 100px;
      object-fit: contain;
    }
    .btn-accion {
      display:block;
      margin:25px auto 0;
      padding:12px 20px;
      background:#0c6cbd;
      color:white;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }
    .btn-accion:hover { background:#094a85; }
  </style>
</head>
<body>
  <div class="contenedor" id="resumenSalida">
    <h2>Resumen de Salida ‚Äì Almac√©n L√≠quidos</h2>

    <div class="info">
      <p><b>Folio:</b> <span id="folioResumen"></span></p>
      <p><b>Fecha:</b> <span id="fechaResumen"></span></p>
      <p><b>Entrega:</b> <span id="entregaResumen"></span></p>
      <p><b>Recibe:</b> <span id="recibeResumen"></span></p>
      <p><b>Destino:</b> <span id="destinoResumen"></span></p>
    </div>

    <h3>Productos</h3>
    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Descripci√≥n</th>
          <th>Unidad</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="tablaProductos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <p><b>Firma quien entrega</b></p>
        <img id="firmaEntrega" alt="Firma Entrega">
      </div>
      <div class="firma-box">
        <p><b>Firma quien recibe</b></p>
        <img id="firmaRecibe" alt="Firma Recibe">
      </div>
    </div>
  </div>

  <button class="btn-accion" onclick="guardarYDescargar()">üíæ Guardar en Firebase y Descargar PDF</button>

  <!-- Firebase + librer√≠as -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Recuperar datos
    const datos = JSON.parse(localStorage.getItem("salidaLiquidos")) || {};
    const carrito = JSON.parse(localStorage.getItem("carrito_liquidos") || "[]");
    const firmaEntrega = localStorage.getItem("firmaEntregaLiquidos") || "";
    const firmaRecibe  = localStorage.getItem("firmaRecibeLiquidos") || "";

    // Pintar en resumen
    document.getElementById("folioResumen").textContent   = datos.folio || "";
    document.getElementById("fechaResumen").textContent   = datos.fecha || "";
    document.getElementById("entregaResumen").textContent = datos.entrega || "";
    document.getElementById("recibeResumen").textContent  = datos.recibe || "";
    document.getElementById("destinoResumen").textContent = datos.destino || "";
    document.getElementById("firmaEntrega").src = firmaEntrega;
    document.getElementById("firmaRecibe").src  = firmaRecibe;

    const tabla = document.getElementById("tablaProductos");
    carrito.forEach(p => {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${p.codigo}</td>
        <td>${p.descripcion}</td>
        <td>${p.unidad}</td>
        <td>${p.cantidad}</td>
      `;
      tabla.appendChild(fila);
    });

    // Guardar en Firebase
    async function guardarEnFirebase() {
      const data = {
        ...datos,
        productos: carrito,
        firmaEntrega,
        firmaRecibe,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection("almacenes")
        .doc("Almacen_Liquidos")
        .collection("salidas")
        .add(data);

      // Actualizar consecutivo
      const folioDoc = db.collection("consecutivos").doc("salidas_liquidos");
      const snap = await folioDoc.get();
      if (snap.exists) {
        await folioDoc.update({ ultimo: (snap.data().ultimo || 1) + 1 });
      } else {
        await folioDoc.set({ ultimo: 2 });
      }
    }

    // Descargar PDF tipo ticket
    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const resumen = document.getElementById('resumenSalida');

      // Asegurar que im√°genes est√©n cargadas
      const preload = (imgEl) => new Promise(res=>{
        if (!imgEl) return res();
        if (imgEl.complete) return res();
        imgEl.onload = ()=>res();
        imgEl.onerror = ()=>res();
      });
      await Promise.all([
        preload(document.getElementById('firmaEntrega')),
        preload(document.getElementById('firmaRecibe')),
      ]);

      const canvas = await html2canvas(resumen, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/png');

      const ticketWidthMM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-width-mm')) || 80;
      const marginMM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-margin-mm')) || 5;

      const imgPxWidth = canvas.width;
      const imgPxHeight = canvas.height;
      const usableWidthMM = ticketWidthMM - (marginMM * 2);
      const pxPerMM = imgPxWidth / usableWidthMM;
      const heightMM = imgPxHeight / pxPerMM + (marginMM * 2);

      const pdf = new jsPDF('p', 'mm', [ticketWidthMM, heightMM]);
      pdf.addImage(imgData, 'PNG', marginMM, marginMM, usableWidthMM, imgPxHeight / pxPerMM);

      const nombre = `Salida_${(datos.folio || 'SAL-LIQ').replace(/\s+/g,'_')}.pdf`;
      pdf.save(nombre);
    }

    // Acci√≥n completa con redirecci√≥n
    async function guardarYDescargar() {
      if (!carrito || carrito.length === 0) {
        alert("‚ö†Ô∏è No hay productos en el resumen.");
        return;
      }
      try {
        await guardarEnFirebase();
        await descargarPDF();
        alert("‚úÖ Guardado en Firebase y PDF descargado");

        // üîπ Redirigir autom√°ticamente al index despu√©s de 2 segundos
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);

      } catch (e) {
        alert("‚ùå Error: " + e.message);
      }
    }

    window.guardarYDescargar = guardarYDescargar;
  </script>
</body>
</html>
