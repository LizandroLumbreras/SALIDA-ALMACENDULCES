<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumen Final ‚Äì Almac√©n L√≠quidos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);margin:0;padding:20px;min-height:100vh}
    .contenedor{max-width:950px;margin:auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.2)}
    h2{text-align:center;color:#00416A}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ccc;padding:8px;text-align:center}
    th{background:#00416A;color:#fff}
    .firmas{display:flex;justify-content:space-around;margin-top:30px;flex-wrap:wrap}
    .firma-box{text-align:center;margin:10px}
    .firma-box img{max-width:220px;max-height:120px;border:1px solid #ccc;padding:5px}
    .acciones{margin-top:25px;text-align:center}
    button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-size:16px;margin:5px}
    .btn-prim{background:#0c6cbd;color:#fff}
    .btn-prim:hover{background:#093c6d}
  </style>
</head>
<body>
  <div class="contenedor">
    <h2>üìã Resumen Final ‚Äì Almac√©n L√≠quidos</h2>

    <div id="infoBasica"></div>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Producto</th>
          <th>Unidad</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="tablaProductos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <h4>Firma de quien entrega</h4>
        <img id="firmaEntrega" alt="Firma entrega">
        <p id="nombreEntrega"></p>
      </div>
      <div class="firma-box">
        <h4>Firma de quien recibe</h4>
        <img id="firmaRecibe" alt="Firma recibe">
        <p id="nombreRecibe"></p>
      </div>
    </div>

    <div class="acciones">
      <button class="btn-prim" onclick="guardarSalida()">üíæ Guardar y Descargar</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Cargar datos desde localStorage
    function cargarResumen(){
      const datos = JSON.parse(localStorage.getItem("datosLiquidos")) || {};
      const carrito = JSON.parse(localStorage.getItem("carritoLiquidos")) || [];
      const firmaEntrega = localStorage.getItem("firmaEntregaLiquidos");
      const firmaRecibe = localStorage.getItem("firmaRecibeLiquidos");

      // Datos b√°sicos
      document.getElementById("infoBasica").innerHTML = `
        <p><b>Folio:</b> ${datos.folio || "N/A"}</p>
        <p><b>Fecha:</b> ${datos.fecha || new Date().toLocaleString()}</p>
        <p><b>Destino:</b> ${datos.destino || ""}</p>
        <p><b>Entrega:</b> ${datos.entrega || ""}</p>
        <p><b>Recibe:</b> ${datos.recibe || ""}</p>
      `;

      // Productos
      const tbody = document.getElementById("tablaProductos");
      if(carrito.length === 0){
        tbody.innerHTML = "<tr><td colspan='4'>No hay productos</td></tr>";
      } else {
        tbody.innerHTML = carrito.map(p => `
          <tr>
            <td>${p.codigoBarra}</td>
            <td>${p.concepto}</td>
            <td>${p.unidad || ""}</td>
            <td>${p.cantidad || 1}</td>
          </tr>
        `).join("");
      }

      // Firmas
      if(firmaEntrega){
        document.getElementById("firmaEntrega").src = firmaEntrega;
        document.getElementById("nombreEntrega").innerText = datos.entrega || "";
      }
      if(firmaRecibe){
        document.getElementById("firmaRecibe").src = firmaRecibe;
        document.getElementById("nombreRecibe").innerText = datos.recibe || "";
      }
    }

    // üîπ Guardar en Firebase
    async function guardarSalida(){
      try {
        const datos = JSON.parse(localStorage.getItem("datosLiquidos")) || {};
        const carrito = JSON.parse(localStorage.getItem("carritoLiquidos")) || [];
        const firmaEntrega = localStorage.getItem("firmaEntregaLiquidos");
        const firmaRecibe = localStorage.getItem("firmaRecibeLiquidos");

        if(carrito.length === 0){
          alert("‚ö†Ô∏è No hay productos para guardar");
          return;
        }

        const docRef = await addDoc(collection(db, "almacenes/almacen_liquidos/salidas"), {
          ...datos,
          productos: carrito,
          firmaEntrega,
          firmaRecibe,
          fechaRegistro: serverTimestamp()
        });

        alert("‚úÖ Salida guardada con ID: " + docRef.id);

        // limpiar localStorage despu√©s de guardar
        localStorage.removeItem("datosLiquidos");
        localStorage.removeItem("carritoLiquidos");
        localStorage.removeItem("firmaEntregaLiquidos");
        localStorage.removeItem("firmaRecibeLiquidos");

      } catch (e) {
        console.error("Error al guardar: ", e);
        alert("‚ùå Error al guardar en Firebase");
      }
    }

    cargarResumen();
  </script>
</body>
</html>
