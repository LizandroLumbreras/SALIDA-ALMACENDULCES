<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen de salida - L√≠quidos</title>
  <style>
    :root{
      --ticket-width-mm: 80;
      --ticket-margin-mm: 5;
    }

    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(to right,#00416A,#E4E5E6);
      color: black;
      padding: 20px;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .contenedor{
      background: white;
      border-radius: 10px;
      padding: 16px 14px;
      max-width: 820px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header{text-align: center;margin-bottom: 8px;}
    .logo{
      display:block;margin: 0 auto 6px auto;width: 220px;max-width: 90%;
      image-rendering: -webkit-optimize-contrast;filter: grayscale(0);
    }
    .titulo{margin: 2px 0 8px 0;color: #00416A;font-size: 20px;font-weight: 700;text-align: center;}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px 4px;text-align:center}
    th{background-color:#00416A;color:white}
    .firmas{display:flex;justify-content:space-around;margin-top:18px;gap: 10px;flex-wrap:wrap}
    .firma-box{text-align:center}
    .firma-box img{width:180px;height:auto;border:1px solid #ccc}
    .btn-imprimir{
      display:block;margin:18px auto 0;
      padding:12px 20px;background-color:#0c6cbd;color:white;border:none;
      border-radius:6px;font-size:16px;cursor:pointer
    }
    .btn-imprimir:hover{background-color:#094a85}
    @media print {.btn-imprimir{display:none;}}
  </style>
</head>
<body>
  <div class="contenedor" id="resumenSalida">
    <div class="header">
      <img id="logoEmpresa" class="logo" src="logo_proveedora.webp" alt="Logo La Proveedora" crossOrigin="anonymous">
      <div class="titulo">Resumen de Salida - Almac√©n L√≠quidos</div>
    </div>

    <p><strong>Folio:</strong> <span id="folio"></span></p>
    <p><strong>Fecha y Hora:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Descripci√≥n</th>
          <th>Unidad</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>

    <div class="firmas">
      <div class="firma-box">
        <p>Firma entrega</p>
        <img id="firmaEntrega" alt="Firma entrega">
      </div>
      <div class="firma-box">
        <p>Firma recibe</p>
        <img id="firmaRecibe" alt="Firma recibe">
      </div>
    </div>
  </div>

  <button class="btn-imprimir" id="btnGuardarDescargar">Guardar y descargar PDF</button>

  <!-- Firebase + librer√≠as -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ================== CONFIGURACI√ìN ================== */
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const TOKEN = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
    const CHAT_ID = "6617988297";

    /* ================== IGNORAR ESTOS C√ìDIGOS ================== */
    const CODIGOS_IGNORADOS = [
      "060028","210004","210010","2382",
      "250010","3062","3217","4451","7503033"
    ];

    /* ================== DATOS ================== */
    const datos = JSON.parse(localStorage.getItem('salidaLiquidos') || '{}');
    const productos = JSON.parse(localStorage.getItem('carrito_liquidos') || '[]');

    function leerFirma(keys){
      for(const k of keys){ const v = localStorage.getItem(k);
        if(v?.startsWith('data:image')) return v;
      } return '';
    }
    const firmaEntrega = leerFirma(['firma_entrega_liquidos','firmaEntregaLiquidos','firmaEntrega']);
    const firmaRecibe  = leerFirma(['firma_recibe_liquidos','firmaRecibeLiquidos','firmaRecibe']);

    document.getElementById('folio').textContent = datos.folio || '';
    document.getElementById('fecha').textContent = datos.fecha || new Date().toLocaleString('es-MX');
    document.getElementById('entrega').textContent = datos.entrega || '';
    document.getElementById('recibe').textContent = datos.recibe || '';
    document.getElementById('destino').textContent = datos.destino || '';
    document.getElementById('firmaEntrega').src = firmaEntrega;
    document.getElementById('firmaRecibe').src  = firmaRecibe;

    const tbody = document.getElementById('tabla-productos');
    productos.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${p.codigo??''}</td>
        <td>${p.descripcion??''}</td>
        <td>${p.unidad??''}</td>
        <td>${p.cantidad??0}</td>`;
      tbody.appendChild(tr);
    });

    /* ================== TELEGRAM ================== */
    async function enviarSalidaTelegram(salida){
      try{
        let msg = `üßÉ *Almac√©n L√≠quidos ‚Äì Nueva salida registrada*\n\n`;
        msg += `üìÑ Folio: ${salida.folio || 'Sin folio'}\n`;
        msg += `üìÖ Fecha: ${salida.fecha || new Date().toLocaleString('es-MX')}\n`;
        msg += `üë§ Entrega: ${salida.entrega || 'N/A'}\n`;
        msg += `ü§ù Recibe: ${salida.recibe || 'N/A'}\n`;
        msg += `üìç Destino: ${salida.destino || 'N/A'}\n\n`;
        if(Array.isArray(salida.productos) && salida.productos.length){
          msg += `üì¶ Art√≠culos:\n`;
          salida.productos.forEach(p=>{
            msg += `‚Ä¢ ${p.cantidad} x ${p.descripcion||p.nombre} (C√≥digo: ${p.codigo})\n`;
          });
        }else msg += `‚ö†Ô∏è Sin art√≠culos registrados.\n`;
        await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({chat_id:CHAT_ID,text:msg,parse_mode:"Markdown"})
        });
      }catch(e){ console.warn("No se pudo enviar la notificaci√≥n general:",e); }
    }

    async function enviarAlertaInventario(item,nuevo,minimo){
      const esCritico = nuevo <= minimo;
      let msg = `üßÉ *Almac√©n L√≠quidos ‚Äì Control de Stock*\n\n`;
      if(esCritico){
        msg += `
üî•üî•üî• *ALERTA M√ÅXIMA DE INVENTARIO* üî•üî•üî•
üíÄ *¬°STOCK CR√çTICO DETECTADO!* üíÄ
üì¶ ${item.concepto||item.descripcion||item.nombre}
üÜî C√≥digo: ${item.codigoBarra||item.codigo}
üìâ Existencia actual: ${nuevo}
üî¢ M√≠nimo definido: ${minimo}
üè† Almac√©n: L√≠quidos
üìÖ ${new Date().toLocaleString("es-MX")}
‚ö†Ô∏è *¬°REPOSICI√ìN URGENTE NECESARIA!* ‚ö†Ô∏è
üöíüî•üí£üö®üí•üßØüî•üí•üö®üí£üî•üöí`;
      }else{
        msg += `
‚úÖ *Inventario actualizado correctamente*
üì¶ ${item.concepto||item.descripcion||item.nombre}
üÜî C√≥digo: ${item.codigoBarra||item.codigo}
üìâ Existencia actual: ${nuevo}
üî¢ M√≠nimo definido: ${minimo}
üè† Almac√©n: L√≠quidos
üìÖ ${new Date().toLocaleString("es-MX")}`;
      }
      await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({chat_id:CHAT_ID,text:msg,parse_mode:"Markdown"})
      });
    }

    /* ================== INVENTARIO ================== */
    async function verificarInventarioYNotificar(productos){
      for(const art of productos){
        if (CODIGOS_IGNORADOS.includes(art.codigo)) {
          console.log(`‚öôÔ∏è C√≥digo ${art.codigo} (${art.descripcion}) ignorado.`);
          continue;
        }
        try{
          const snap = await db.collection('seguimiento_inventario')
            .where('codigoBarra','==',art.codigo)
            .where('activo','==',true)
            .get();
          if(!snap.empty){
            snap.forEach(async doc=>{
              const data = doc.data();
              const ref = db.collection('seguimiento_inventario').doc(doc.id);
              const invActual = parseInt(data.inventario_fijado||0);
              const minimo = parseInt(data.inventario_minimo||0);
              const nuevo = Math.max(0, invActual - parseInt(art.cantidad||0));
              await ref.update({
                inventario_fijado: nuevo,
                ultima_salida: new Date().toISOString(),
                actualizadoEn: new Date().toISOString()
              });
              await enviarAlertaInventario(data, nuevo, minimo);
            });
          }else{
            console.log(`‚ÑπÔ∏è C√≥digo ${art.codigo} no est√° en seguimiento_inventario.`);
          }
        }catch(err){ console.error("‚ùå Error en inventario:", err); }
      }
    }

    /* ================== GUARDAR SALIDA ================== */
    async function guardarSalida(){
      const data = {
        ...datos,
        productos,
        firmaEntrega,
        firmaRecibe,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('almacenes').doc('Almacen_Liquidos')
        .collection('salidas').add(data);
      const folioDoc = db.collection('consecutivos').doc('salidas_liquidos');
      const snap = await folioDoc.get();
      if(snap.exists){
        await folioDoc.update({ultimo:(snap.data().ultimo||1)+1});
      }else{
        await folioDoc.set({ultimo:2});
      }
      await enviarSalidaTelegram(data);
      await verificarInventarioYNotificar(productos);
    }

    /* ================== PDF ================== */
    function preload(imgEl){ return new Promise(res=>{
      if(!imgEl)return res(); if(imgEl.complete)return res();
      imgEl.onload=()=>res(); imgEl.onerror=()=>res();
    });}
    async function descargarPDF(){
      const { jsPDF } = window.jspdf;
      const resumen = document.getElementById('resumenSalida');
      await Promise.all([
        preload(document.getElementById('logoEmpresa')),
        preload(document.getElementById('firmaEntrega')),
        preload(document.getElementById('firmaRecibe'))
      ]);
      const canvas = await html2canvas(resumen,{scale:2,useCORS:true,backgroundColor:'#fff'});
      const imgData = canvas.toDataURL('image/png');
      const ticketWidthMM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-width-mm'))||80;
      const marginMM = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ticket-margin-mm'))||5;
      const imgPxWidth=canvas.width,imgPxHeight=canvas.height;
      const usableWidthMM=ticketWidthMM-(marginMM*2);
      const pxPerMM=imgPxWidth/usableWidthMM;
      const heightMM=imgPxHeight/pxPerMM+(marginMM*2);
      const pdf=new jsPDF('p','mm',[ticketWidthMM,heightMM]);
      pdf.addImage(imgData,'PNG',marginMM,marginMM,usableWidthMM,imgPxHeight/pxPerMM);
      pdf.save(`Comprobante_${(datos.folio||'SAL-LIQ').replace(/\s+/g,'_')}.pdf`);
    }

    /* ================== EVENTO PRINCIPAL ================== */
    document.getElementById('btnGuardarDescargar').addEventListener('click', async ()=>{
      if(!productos||productos.length===0){alert("No hay productos.");return;}
      try{
        await guardarSalida();
        await descargarPDF();
        setTimeout(()=>{localStorage.removeItem('carrito_liquidos');location.href='index.html';},1500);
      }catch(e){alert("Error: "+e.message);}
    });
  </script>
</body>
</html>
